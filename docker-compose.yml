services:
  # Nginx代理服务，使用OpenResty 1.25.3.1，支持HTTP/3和Brotli
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: poetize-nginx
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    volumes:
      - poetize_ui_dist:/usr/share/nginx/html/poetize
      - poetize_im_dist:/usr/share/nginx/html/im
      - poetize_uploads:/usr/share/nginx/html/uploads
      - ./docker/nginx/enable-https.sh:/enable-https.sh
      - ./py/data:/app/data
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - web-root:/usr/share/nginx/html
      - ./docker/nginx/lua:/etc/nginx/lua
    ports:
      - "80:80/tcp"
      - "443:443/tcp"
      - "443:443/udp"
    networks:
      poetize-network:
        ipv4_address: 172.28.147.2
    depends_on:
      poetize-ui:
        condition: service_completed_successfully
      poetize-im-ui:
        condition: service_completed_successfully
      java-backend:
        condition: service_healthy
      python-backend:
        condition: service_healthy
    restart: always

  # 主站前端（Vue 2）
  poetize-ui:
    build:
      context: .
      dockerfile: docker/poetize-ui/Dockerfile
      args:
        - VUE_APP_POETIZE_AES_KEY=${POETIZE_AES_KEY:-sarasarasarasara}
    container_name: poetize-ui
    volumes:
      - ./poetize-ui:/app/src
      - poetize_node_modules:/app/src/node_modules
      - poetize_ui_dist:/app/dist
    networks:
      poetize-network:
        ipv4_address: 172.28.147.3
    restart: "no"
    working_dir: /app/src
    command: ["sh", "-c", "echo '=== 构建博客前端 (Vue 2) ===' && \
                           npm config set registry https://registry.npmmirror.com && \
                           echo '=== 清理npm缓存 ===' && \
                           npm cache clean --force && \
                           npm cache verify && \
                           echo '=== 清理node_modules目录以避免ENOTEMPTY错误 ===' && \
                           rm -rf node_modules/.package-lock.json 2>/dev/null || true && \
                           rm -rf node_modules/.staging 2>/dev/null || true && \
                           find node_modules -name '.git' -type d -exec rm -rf {} + 2>/dev/null || true && \
                           echo '=== 安装依赖 ===' && \
                           npm install --force --legacy-peer-deps --no-fund --no-audit --prefer-offline --maxsockets 1 --network-timeout=300000 && \
                           echo '=== 安装Brotli压缩工具 ===' && \
                           (npm install -g brotli --no-fund --no-audit --maxsockets 1 || echo '警告: brotli安装失败，将跳过.br文件生成') && \
                           echo '=== 运行构建 ===' && \
                           npm run build && \
                           echo '=== 构建完成，复制dist目录内容到挂载点 ===' && \
                           cp -rf dist/* /app/dist/ && \
                           echo '=== 处理静态资源 ===' && \
                           if [ -d \"dist/static\" ]; then \
                             echo '从dist/static复制静态资源' && \
                             mkdir -p /app/dist/static && \
                             cp -rf dist/static/* /app/dist/static/ 2>/dev/null || true; \
                           elif [ -d \"public/static\" ]; then \
                             echo '从public/static复制静态资源' && \
                             mkdir -p /app/dist/static && \
                             cp -rf public/static/* /app/dist/static/ 2>/dev/null || true; \
                           else \
                             echo '未找到静态资源目录'; \
                           fi && \
                           echo '主站构建完成' && \
                           touch /app/dist/.ui_ready"]

  # 聊天室前端（Vue 3）
  poetize-im-ui:
    build:
      context: .
      dockerfile: docker/poetize-im-ui/Dockerfile
      args:
        - VUE_APP_POETIZE_AES_KEY=${POETIZE_AES_KEY:-sarasarasarasara}
    container_name: poetize-im-ui
    volumes:
      - ./poetize-im-ui:/app/src
      - im_node_modules:/app/src/node_modules
      - poetize_im_dist:/app/dist
    networks:
      poetize-network:
        ipv4_address: 172.28.147.4
    # depends_on:
    #   poetize-ui:
    #     condition: service_completed_successfully
    restart: "no"
    working_dir: /app/src
    command: ["sh", "-c", "echo '=== 构建聊天室前端 (Vue 3) ===' && \
                           npm config set registry https://registry.npmmirror.com && \
                           echo '=== 清理node_modules目录以避免ENOTEMPTY错误 ===' && \
                           rm -rf node_modules/.package-lock.json 2>/dev/null || true && \
                           rm -rf node_modules/.staging 2>/dev/null || true && \
                           find node_modules -name '.git' -type d -exec rm -rf {} + 2>/dev/null || true && \
                           echo '=== 安装依赖 ===' && \
                           if [ -f package-lock.json ]; then \
                             echo '使用npm ci安装依赖' && \
                             npm ci --prefer-offline --no-audit --no-fund --maxsockets 1 --network-timeout=300000 || \
                             (echo '使用npm ci失败，回退到npm install' && \
                             npm install --prefer-offline --no-audit --no-fund --legacy-peer-deps --maxsockets 1 --network-timeout=300000); \
                           else \
                             echo '无package-lock.json，使用npm install' && \
                             npm install --prefer-offline --no-audit --no-fund --legacy-peer-deps --maxsockets 1 --network-timeout=300000; \
                           fi && \
                           echo '=== 安装Brotli压缩工具 ===' && \
                           npm install -g brotli --no-fund --no-audit --maxsockets 1 2>/dev/null || echo '警告: brotli安装失败，将跳过.br文件生成' && \
                           echo '=== 运行构建 ===' && \
                           npm run build && \
                           echo '=== 构建完成，复制dist目录内容到挂载点 ===' && \
                           cp -rf dist/* /app/dist/ && \
                           echo '聊天室构建完成'"]

  certbot:
    image: certbot/certbot
    container_name: poetize-certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - web-root:/usr/share/nginx/html
      - ./docker/nginx/certbot-logs:/var/log/letsencrypt
      - ./docker/nginx/certbot-entrypoint.sh:/certbot-entrypoint.sh
    networks:
      poetize-network:
        ipv4_address: 172.28.147.5
    depends_on:
      - nginx
    restart: "no"
    entrypoint: []
    command: sh /certbot-entrypoint.sh

  python-backend:
    build:
      context: .
      dockerfile: docker/python/Dockerfile
    container_name: poetize-python
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - PORT=5000
      - JAVA_BACKEND_HOST=poetize-java
      - JAVA_BACKEND_PORT=8081
      - FRONTEND_HOST=example.com
      - NGINX_URL=http://nginx/flush_seo_cache
      - PRERENDER_URL=http://poetize-prerender:4000
      - DOCKER_SUBNET=172.28.147.0/28
      # Redis配置
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=poetize_redis_2025
      - REDIS_DB=0
      - REDIS_MAX_CONNECTIONS=20
    volumes:
      - ./py/data:/app/data
    networks:
      poetize-network:
        ipv4_address: 172.28.147.6
    depends_on:
      java-backend:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 40s

  # # Ollama翻译模型服务
  # translation-model:
  #   build:
  #     context: .
  #     dockerfile: docker/translation_model/Dockerfile
  #   container_name: poetize-translation-model
  #   environment:
  #     - OLLAMA_HOST=0.0.0.0:11434
  #     - OLLAMA_ORIGINS=*
  #     - OLLAMA_MODELS=qwen3:0.6b
  #     - OLLAMA_KEEP_ALIVE=-1
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   networks:
  #     - poetize-network
  #   restart: always
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
  #     interval: 60s
  #     timeout: 30s
  #     retries: 3
  #     start_period: 1200s

  java-backend:
    build:
      context: .
      dockerfile: docker/java/Dockerfile
    container_name: poetize-java
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    volumes:
      - poetize_uploads:/app/static
    environment:
      - JAVA_OPTS=-Xmx256m -Xms128m -XX:MaxMetaspaceSize=96m -XX:CompressedClassSpaceSize=48m -Xss512k -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+DisableExplicitGC
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mysql:3306/poetize?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=poetize
      - SPRING_DATASOURCE_PASSWORD=poetize123
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.mariadb.jdbc.Driver
      - SERVER_PORT=8081
      - PYTHON_SERVICE_URL=http://poetize-python:5000
      - POETIZE_AES_KEY=${POETIZE_AES_KEY:-sarasarasarasara}
      - TRANSLATION_LOCAL_URL=http://poetize-python:5000/api/translate
      - TRANSLATION_LOCAL_ENABLED=true
      - LOCAL_ENABLE=true
      - LOCAL_UPLOADURL=/app/static
      - LOCAL_DOWNLOADURL=/static
      - OLLAMA_MODEL_NAME=qwen3:0.6b
      - PRERENDER_URL=http://poetize-prerender:4000/render
      - PRERENDER_PAGES_URL=http://poetize-prerender:4000/render/pages
      - SITE_URL=http://example.com
      - DOCKER_SUBNET=172.28.147.0/28
      # Redis配置
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=poetize_redis_2025
      - SPRING_REDIS_DATABASE=0
      - SPRING_REDIS_TIMEOUT=3000
      - SPRING_REDIS_LETTUCE_POOL_MAX_ACTIVE=20
      - SPRING_REDIS_LETTUCE_POOL_MAX_IDLE=10
      - SPRING_REDIS_LETTUCE_POOL_MIN_IDLE=5
      # Token安全配置
      - TOKEN_SECRET_KEY=your_super_secure_random_key_here_at_least_32_chars
    networks:
      poetize-network:
        ipv4_address: 172.28.147.7
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      poetize-ui:
        condition: service_completed_successfully
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Redis缓存服务
  redis:
    image: redis:7-alpine
    container_name: poetize-redis
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      poetize-network:
        ipv4_address: 172.28.147.10
    restart: always
    command: ["redis-server", "/usr/local/etc/redis/redis.conf", "--requirepass", "poetize_redis_2025"]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "poetize_redis_2025", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MariaDB服务
  mysql:
    build:
      context: .
      dockerfile: docker/mysql/Dockerfile
    container_name: poetize-mariadb
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/conf/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    environment:
      - MARIADB_ROOT_PASSWORD=root123
      - MARIADB_DATABASE=poetize
      - MARIADB_USER=poetize
      - MARIADB_PASSWORD=poetize123
    networks:
      poetize-network:
        ipv4_address: 172.28.147.8
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h localhost -u poetize -ppoetize123 && echo 'SHOW ENGINES' | mariadb -h localhost -u poetize -ppoetize123 | grep -q 'ROCKSDB'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  prerender-worker:
    build:
      context: ./docker/prerender
      dockerfile: Dockerfile
    container_name: poetize-prerender
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - PORT=4000
      - LOG_LEVEL=info
      - PRERENDER_BASE_URL=http://nginx
      - PRERENDER_OUTPUT=/app/dist/prerender
      - JAVA_BACKEND_URL=http://poetize-java:8081
      - PYTHON_BACKEND_URL=http://poetize-python:5000
      - SITE_URL=http://example.com
      - NODE_ENV=production
    volumes:
      - poetize_ui_dist:/app/dist
      - ./poetize-ui:/app/poetize-ui
    networks:
      poetize-network:
        ipv4_address: 172.28.147.9
    depends_on:
      nginx:
        condition: service_started
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  poetize-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.147.0/28
          gateway: 172.28.147.1
          ip_range: 172.28.147.0/28

volumes:
  mysql_data:
  redis_data:
  certbot-etc:
  certbot-var:
  web-root:
  poetize_node_modules:
  im_node_modules:
  poetize_ui_dist:
  poetize_im_dist:
  poetize_uploads:
  ollama_data:
