# 定义请求限制区域
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=user_limit:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=python_limit:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=translation_limit:10m rate=3r/s;
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=2r/s;

# 文章页 SSR 服务 upstream
# upstream article_ssr {
#     server poetize-article-ssr:3000;
#     keepalive 16;
# }

# 添加map指令用于解析请求URI，提取文章ID、分类ID等
map $request_uri $article_id {
    ~^/article/([0-9]+)$ $1;
    default "";
}

map $request_uri $category_id {
    ~^/category/([0-9]+)$ $1;
    default "";
}

map $request_uri $tag_id {
    ~^/tag/([0-9]+)$ $1;
    default "";
}

# 解析sort页面的参数
map $args $sort_id {
    ~sortId=([0-9]+) $1;
    default "";
}

map $args $label_id {
    ~labelId=([0-9]+) $1;
    default "";
}

# 增加IM相关的map指令
map $request_uri $is_im_page {
    ~^/im.*$ 1;
    default 0;
}

# 添加map解析 lang 参数
map $arg_lang $lang_suffix {
    default "";
    en "-en";
    ch "";
}

server {
    listen 80;
    server_name example.com www.example.com;
    
    # 设置访问日志路径
    access_log /var/log/nginx/access.log main;
    
    # 设置默认字符集
    charset utf-8;
    # HTTP/3
    add_header Alt-Svc 'h3=":443"; ma=86400';
    
    # 添加更多安全头信息
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.jsdelivr.net cdn.jsdelivr.net *.cloudflare.com cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' *.jsdelivr.net *.cloudflare.com cdnjs.cloudflare.com fonts.googleapis.com; img-src 'self' data: blob: *; font-src 'self' data: *.jsdelivr.net *.cloudflare.com cdnjs.cloudflare.com fonts.googleapis.com fonts.gstatic.com; connect-src 'self' *;" always;
    
    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN";
    
    # 限制请求大小，防止DoS攻击
    client_max_body_size 10M;
    
    # 启用Brotli压缩 - 比GZIP更高效的压缩算法
    brotli on;
    brotli_comp_level 6;
    brotli_static on;
    brotli_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/x-font-ttf application/x-font-opentype application/font-woff application/font-woff2 font/woff2 image/svg+xml;
    
    # 启用GZIP压缩，但避免对已加密内容进行压缩
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length 256;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    
    # 内部代理location - 仅供内部请求使用
    location /internal_proxy/ {
        internal;
        # 移除/internal_proxy前缀
        rewrite ^/internal_proxy(/.*)$ $1 break;
        proxy_pass http://poetize-python:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        try_files $uri $uri/ /index.html;
    }
    
    # 先匹配文章详情页，交由 Node SSR 处理
    # location ~ ^/article/[0-9]+$ {
    #     proxy_pass http://article_ssr;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #
    #     # 当 SSR 服务不可用时回退到 SPA
    #     proxy_next_upstream error timeout http_502 http_503 http_504;
    #     proxy_intercept_errors on;
    #     error_page 502 503 504 = /index.html;
    # }

    # 文章页静态预渲染
    location ~ ^/article/([0-9]+)(\?.*)?$ {
        # 明确静态文件根目录，避免继承不到 root 而导致 try_files 路径解析错误
        root /usr/share/nginx/html/poetize;
        # 根据 $lang_suffix 智能选择文件：en->index-en.html，否则 index.html
        try_files /prerender/article/$1/index$lang_suffix.html /prerender/article/$1/index.html @spa_article;
    }
    location @spa_article {
        root /usr/share/nginx/html/poetize;
        try_files $uri $uri/ /index.html;
    }

    # 首页静态预渲染
    location = / {
        root /usr/share/nginx/html/poetize;
        try_files /prerender/home/index$lang_suffix.html /prerender/home/index.html @spa_home;
    }
    location @spa_home {
        root /usr/share/nginx/html/poetize;
        try_files $uri $uri/ /index.html;
    }

    # 百宝箱页面静态预渲染
    location = /favorite {
        root /usr/share/nginx/html/poetize;
        try_files /prerender/favorite/index$lang_suffix.html /prerender/favorite/index.html @spa_favorite;
    }
    location @spa_favorite {
        root /usr/share/nginx/html/poetize;
        try_files $uri $uri/ /index.html;
    }

    # Sort页面静态预渲染 - 使用Lua脚本智能处理
    location = /sort {
        # 使用content_by_lua_block完全控制响应，避免与try_files冲突
        content_by_lua_block {
            local sort_id = ngx.var.sort_id
            local label_id = ngx.var.label_id
            local lang_suffix = ngx.var.lang_suffix
            
            local paths = {}
            
            if sort_id and sort_id ~= "" then
                if label_id and label_id ~= "" then
                    -- 有标签ID，优先尝试带标签的路径
                    table.insert(paths, "/prerender/sort/" .. sort_id .. "/" .. label_id .. "/index" .. lang_suffix .. ".html")
                    table.insert(paths, "/prerender/sort/" .. sort_id .. "/" .. label_id .. "/index.html")
                end
                
                -- 添加只有分类ID的路径
                table.insert(paths, "/prerender/sort/" .. sort_id .. "/index" .. lang_suffix .. ".html")
                table.insert(paths, "/prerender/sort/" .. sort_id .. "/index.html")
            else
                -- 没有sortId参数，尝试默认的sort页面
                table.insert(paths, "/prerender/sort/index" .. lang_suffix .. ".html")
                table.insert(paths, "/prerender/sort/index.html")
            end
            
            -- 检查文件是否存在并返回内容
            for _, path in ipairs(paths) do
                local file_path = "/usr/share/nginx/html/poetize" .. path
                local file = io.open(file_path, "r")
                if file then
                    local content = file:read("*a")
                    file:close()
                    
                    -- 设置正确的内容类型
                    ngx.header.content_type = "text/html; charset=utf-8"
                    ngx.say(content)
                    return
                end
            end
            
            -- 没有找到预渲染文件，回退到SPA
            ngx.exec("@spa_sort")
        }
    }
    
    location @spa_sort {
        root /usr/share/nginx/html/poetize;
        try_files $uri $uri/ /index.html;
    }

    # 主站前端
    location / {
        root /usr/share/nginx/html/poetize;
        index index.html;
        
        # 开启SSI处理
        ssi on;
        ssi_silent_errors on;
        
        # 在访问阶段统一处理SEO信息
        access_by_lua_file   /etc/nginx/lua/seo_access.lua;
        
        # 用于在模板中插入完整的头部信息
        header_filter_by_lua_file /etc/nginx/lua/seo_header_filter.lua;
        
        body_filter_by_lua_file /etc/nginx/lua/seo_body_filter.lua;
        
        # 配置sub_filter替换规则 - 尝试替换占位符
        set $seo_data "";
        set $title_data "";
        set $icon_data "";
        sub_filter "<!-- SEO_META_PLACEHOLDER -->" $seo_data;
        sub_filter "<!-- ICON_META_PLACEHOLDER -->" $icon_data;
        sub_filter "<head>" "<head>$seo_data$icon_data";
        
        # 尝试替换title标签
        sub_filter "<title>" "<title>$title_data";
        sub_filter "</title>" "</title>";
        
        # 最后尝试匹配文件路径
        try_files $uri $uri/ /index.html;
        
        # Live2D资源预加载 - 使用JavaScript preload代替http2_push
        # 注：HTTP/3不支持Server Push，改用<link rel="preload">方式
        location = /index.html {
            # 为index.html设置不缓存，确保用户总能获取最新的应用入口
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
            add_header Pragma "no-cache";

            root /usr/share/nginx/html/poetize;
            add_header Link '</static/live2d-widget/dist/live2d.min.js>; rel=preload; as=script';
            add_header Link '</static/live2d-widget/dist/waifu.css>; rel=preload; as=style';
            add_header Link '</static/live2d_api/model_list.json>; rel=preload; as=fetch; crossorigin=anonymous';
        }
    }
    
    # Let's Encrypt验证 - 保留此部分以便certbot可以验证域名
    location /.well-known/acme-challenge/ {
        root /usr/share/nginx/html;
        allow all;
    }
    
    # 聊天室前端静态资源
    location ~ ^/im/(css|js|static)/ {
        root /usr/share/nginx/html;
        expires 30d;
        add_header Cache-Control "public, no-transform";
        
        # 设置正确的MIME类型
        location ~* \.css$ {
            add_header Content-Type text/css;
        }
        location ~* \.js$ {
            add_header Content-Type application/javascript;
        }
        
        # 如果文件不存在，返回404而不是fallback到HTML
        try_files $uri =404;
    }

    # 聊天室前端HTML页面
    location /im {
        alias /usr/share/nginx/html/im;
        index index.html;
        
        # 开启SSI处理
        ssi on;
        ssi_silent_errors on;
        
        # 启用sub_filter进行替换 - 更直接的替换方式
        sub_filter_once on;
        sub_filter_types text/html;
        
        # 在访问阶段处理IM聊天室SEO信息
        access_by_lua_file /etc/nginx/lua/im_seo_access.lua;
        
        # 用于在模板中插入完整的头部信息
        header_filter_by_lua_file /etc/nginx/lua/seo_header_filter.lua;
        
        body_filter_by_lua_file /etc/nginx/lua/im_seo_body_filter.lua;
        
        # 只对HTML文件使用fallback
        try_files $uri $uri/ /im/index.html;
    }

    # assets目录 - 直接指向static/assets
    location /assets/ {
        alias /usr/share/nginx/html/poetize/static/assets/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
        
        # 特殊处理视频文件，支持流式传输
        location ~* \.(mp4|webm|ogg|avi|mov|flv|wmv|mkv)$ {
            alias /usr/share/nginx/html/poetize/static/assets/;
            
            # 防盗链保护 - 只允许本站和空referer访问
            valid_referers none blocked server_names ~\.example\.com$ example.com;
            if ($invalid_referer) {
                return 403;
            }
            
            # 启用HTTP Range请求支持，允许视频流式加载
            add_header Accept-Ranges bytes;
            
            # 设置适当的MIME类型
            location ~* \.mp4$ {
                add_header Content-Type video/mp4;
            }
            location ~* \.webm$ {
                add_header Content-Type video/webm;
            }
            location ~* \.ogg$ {
                add_header Content-Type video/ogg;
            }
            
            # 视频文件缓存策略 - 较长缓存但允许验证
            expires 7d;
            add_header Cache-Control "public, max-age=604800, must-revalidate";
            
            # 启用sendfile和tcp_nopush优化大文件传输
            sendfile on;
            tcp_nopush on;
            tcp_nodelay off;
            
            # 支持跨域访问（如果需要）
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';
            add_header Access-Control-Allow-Headers 'Range';
            
            # 禁用gzip和brotli压缩（视频文件已经压缩过了）
            gzip off;
            brotli off;
        }
    }

    # 静态资源 - 同时尝试从poetize目录直接找，或从poetize/static子目录找
    location /static {
        try_files $uri @fallback_static;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # 为特定的chunk JS文件添加特殊处理
    location ~* chunk-.*\.js$ {
        root /usr/share/nginx/html/poetize;
        # 设置正确的MIME类型
        types { application/javascript js; }
        # 禁用压缩
        gzip off;
        brotli off;
        # 启用永久缓存
        expires max;
        add_header Cache-Control "public, max-age=31536000, immutable";
        # 记录详细的访问日志用于调试
        access_log /var/log/nginx/chunk_debug.log main;
    }

    # Live2D模型和相关资源 - 专门优化Live2D资源的缓存
    location /static/live2d_api/ {
        root /usr/share/nginx/html/poetize;
        expires max;  # 使用最长缓存时间，因为模型文件很少变化
        add_header Cache-Control "public, max-age=31536000, immutable";
        
        # 配置跨域
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        
        # 特别优化model_list.json的缓存
        location ~ model_list\.json$ {
            expires 1d;  # 模型列表可能会更新，使用较短的缓存时间
            add_header Cache-Control "public, max-age=86400";
        }
        
        # 禁用access_log以减少磁盘IO
        access_log off;
    }
    
    # Live2D小部件JS和CSS资源
    location /static/live2d-widget/ {
        root /usr/share/nginx/html/poetize;
        expires 7d;  # 一周的缓存时间
        add_header Cache-Control "public, max-age=604800";
        
        # 禁用access_log以减少磁盘IO
        access_log off;
    }

    # 静态资源回退路径
    location @fallback_static {
        root /usr/share/nginx/html/poetize;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # 站点地图和robots.txt文件
    location /sitemap.xml {
        alias /app/data/sitemap.xml;
    }
    
    location /robots.txt {
        alias /app/data/robots.txt;
    }

    # Java后端API
    location /api/ {
        # 增加请求速率限制，防止暴力攻击
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://poetize-java:8081/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Java后端用户相关API - 添加此段，确保与其他配置一致
    location /user/ {
        # 增加更严格的请求速率限制，防止暴力破解登录
        limit_req zone=user_limit burst=5 nodelay;
        
        proxy_pass http://poetize-java:8081/user/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
    
    location /socket {
        proxy_pass          http://poetize-java:9324;
        proxy_http_version  1.1;
        proxy_set_header    Upgrade $http_upgrade;
        proxy_set_header    Connection "upgrade";
        proxy_read_timeout  600s;
    }

    # Python后端API
    location /python/ {
        # 增加请求速率限制，防止暴力攻击
        limit_req zone=python_limit burst=10 nodelay;
        
        proxy_pass http://poetize-python:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 清理SEO缓存接口，后台修改SEO配置后调用
    location = /flush_seo_cache {
        # 只允许内部/本地访问
        allow all;

        content_by_lua_block {
            local seo_cache = ngx.shared.seo_cache
            seo_cache:flush_all()
            ngx.say("seo cache flushed")
        }
    }
}