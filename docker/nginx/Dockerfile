FROM openresty/openresty:1.25.3.1-alpine AS builder


RUN apk update

# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache \
    build-base \
    git \
    cmake \
    brotli-dev \
    pcre-dev \
    zlib-dev \
    openssl-dev \
    curl \
    wget \
    busybox-extras
 
# ä¸‹è½½ngx_brotliæ¨¡å—
WORKDIR /usr/src
RUN set -e; \
    echo "ğŸ”§ å°è¯•ä¸‹è½½ngx_brotliæ¨¡å—..."; \
    # é¦–å…ˆå°è¯•GitHubå®˜æ–¹
    if timeout -s TERM 240 \
        git clone --depth=1 --shallow-submodules --recursive https://github.com/google/ngx_brotli.git; then \
        echo "âœ… ä»GitHubä¸‹è½½ngx_brotliæˆåŠŸ"; \
    # å¦‚æœGitHubå¤±è´¥ï¼Œå°è¯•Giteeé•œåƒ
    elif timeout -s TERM 240 \
        git clone --depth=1 https://gitee.com/lirko/ngx_brotli.git; then \
        echo "ğŸ”„ Gitee ä¸»ä»“åº“æˆåŠŸï¼Œå¼€å§‹å¤„ç†å­æ¨¡å—â€¦"; \
        cd ngx_brotli && \
        # æŠŠå­æ¨¡å—åœ°å€æ”¹åˆ° Gitee é•œåƒ
        git submodule set-url deps/brotli https://gitee.com/mities/brotli.git && \
        # æµ…å…‹éš†å­æ¨¡å—
        git submodule update --init --depth=1 --recommend-shallow && \
        echo "âœ… å­æ¨¡å— brotli å·²å°±ä½"; \
        cd ..; \
    else \
        echo "âŒ æ‰€æœ‰ngx_brotliä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"; \
        exit 1; \
    fi

# è·å–Nginxç‰ˆæœ¬
RUN nginx -v 2>&1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' > /tmp/nginx_version

# ç¼–è¯‘Brotliæ¨¡å—
WORKDIR /usr/src/ngx_brotli
RUN set -e; \
    if [ -f "config" ]; then \
        echo "ğŸ”§ å¼€å§‹ç¼–è¯‘Brotliæ¨¡å—..."; \
        NGINX_VERSION=$(cat /tmp/nginx_version); \
        # å°è¯•å¤šä¸ªNginxä¸‹è½½æº
        if wget --timeout=120 --tries=3 https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»nginx.orgä¸‹è½½æˆåŠŸ"; \
        elif wget --timeout=120 --tries=3 https://mirrors.huaweicloud.com/nginx/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»åä¸ºäº‘ä¸‹è½½æˆåŠŸï¼Œæ„Ÿè°¢newbeåšå®¢çš„æ•´ç†"; \
        elif wget --timeout=120 --tries=3 https://mirror.azure.cn/nginx/download/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»Azureä¸‹è½½æˆåŠŸ"; \
        elif wget --timeout=120 --tries=3 https://mirrors.sohu.com/nginx/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»æœç‹ä¸‹è½½æˆåŠŸ"; \
        else \
            echo "âŒ Nginxæºç ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"; \
            exit 1; \
        fi; \
        tar -xzf nginx-${NGINX_VERSION}.tar.gz && \
        cd nginx-${NGINX_VERSION} && \
        ./configure --with-compat --add-dynamic-module=/usr/src/ngx_brotli && \
        make modules && \
        mkdir -p /usr/local/openresty/nginx/modules/ && \
        cp objs/ngx_http_brotli_filter_module.so /usr/local/openresty/nginx/modules/ 2>/dev/null || true && \
        cp objs/ngx_http_brotli_static_module.so /usr/local/openresty/nginx/modules/ 2>/dev/null || true; \
        echo "ğŸ‰ Brotliæ¨¡å—ç¼–è¯‘å®Œæˆ"; \
    else \
        echo "â­ï¸ ngx_brotliæœªæ­£ç¡®ä¸‹è½½"; \
        exit 1; \
    fi

# æœ€ç»ˆé•œåƒ
FROM openresty/openresty:1.25.3.1-alpine

RUN apk update

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    brotli \
    pcre \
    zlib \
    git \
    openssl \
    openssl-dev \
    build-base \
    curl \
    wget \
    busybox-extras

# å®‰è£…lua-resty-openssl
RUN set -e; \
    cd /tmp; \
    echo "ğŸ”§ å°è¯•å®‰è£…lua-resty-openssl..."; \
    # é¦–å…ˆå°è¯•GitHub
    if timeout -s TERM 240 \
        git clone --depth=1 https://github.com/fffonion/lua-resty-openssl.git; then \
        echo "âœ… ä»GitHubä¸‹è½½lua-resty-opensslæˆåŠŸ"; \
    # å¦‚æœGitHubå¤±è´¥ï¼Œå°è¯•Gitee
    elif timeout -s TERM 240 \
        git clone --depth=1 https://gitee.com/mirrors_fffonion/lua-resty-openssl.git; then \
        echo "ğŸ”„ ä»Giteeä¸‹è½½lua-resty-opensslæˆåŠŸ"; \
    # å¦‚æœéƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½
    elif wget -O lua-resty-openssl.tar.gz https://github.com/fffonion/lua-resty-openssl/archive/refs/heads/master.tar.gz && \
         tar -xzf lua-resty-openssl.tar.gz && mv lua-resty-openssl-master lua-resty-openssl; then \
        echo "ğŸ”„ ä»taråŒ…ä¸‹è½½lua-resty-opensslæˆåŠŸ"; \
    else \
        echo "âŒ lua-resty-opensslä¸‹è½½å¤±è´¥"; \
        exit 1; \
    fi; \
    cd lua-resty-openssl && \
    mkdir -p /usr/local/openresty/lualib/resty/openssl && \
    cp -r lib/resty/openssl/* /usr/local/openresty/lualib/resty/openssl/ 2>/dev/null || true && \
    cp lib/resty/openssl.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true; \
    echo "âœ… lua-resty-opensslå®‰è£…å®Œæˆ"

# å®‰è£…lua-resty-httpæ¨¡å—
RUN set -e; \
    mkdir -p /usr/local/openresty/lualib/resty; \
    cd /tmp; \
    echo "ğŸ”§ å°è¯•å®‰è£…lua-resty-http..."; \
    # é¦–å…ˆå°è¯•GitHub
    if timeout -s TERM 240 \
        git clone --depth=1 https://github.com/ledgetech/lua-resty-http.git; then \
        echo "âœ… ä»GitHubä¸‹è½½lua-resty-httpæˆåŠŸ"; \
    # å¦‚æœGitHubå¤±è´¥ï¼Œå°è¯•Gitee
    elif timeout -s TERM 240 \
        git clone --depth=1 https://gitee.com/mirrors_ledgetech/lua-resty-http.git; then \
        echo "ğŸ”„ ä»Giteeä¸‹è½½lua-resty-httpæˆåŠŸ"; \
    # å¦‚æœéƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½
    elif wget -O lua-resty-http.tar.gz https://github.com/ledgetech/lua-resty-http/archive/refs/heads/master.tar.gz && \
         tar -xzf lua-resty-http.tar.gz && mv lua-resty-http-master lua-resty-http; then \
        echo "ğŸ”„ ä»taråŒ…ä¸‹è½½lua-resty-httpæˆåŠŸ"; \
    else \
        echo "âŒ lua-resty-httpä¸‹è½½å¤±è´¥"; \
        exit 1; \
    fi; \
    cd lua-resty-http && \
    cp lib/resty/http.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true && \
    cp lib/resty/http_headers.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true && \
    cp lib/resty/http_connect.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true && \
    cp -r lib/ngx /usr/local/openresty/lualib/ 2>/dev/null || true; \
    echo "âœ… lua-resty-httpå®‰è£…å®Œæˆ"

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /var/log/nginx /var/cache/nginx

# ä»builderä¸­å¤åˆ¶Brotliæ¨¡å—
COPY --from=builder /usr/local/openresty/nginx/modules/ /usr/local/openresty/nginx/modules/

# åˆ›å»ºé…ç½®ç›®å½•
RUN mkdir -p /usr/local/openresty/nginx/conf/conf.d

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®
COPY nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

# æš´éœ²ç«¯å£
EXPOSE 80 443/tcp 443/udp

# å¯åŠ¨å‘½ä»¤
CMD ["openresty", "-g", "daemon off;"] 