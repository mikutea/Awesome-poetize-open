FROM openresty/openresty:1.25.3.1-alpine AS builder


RUN apk update

# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache \
    build-base \
    git \
    cmake \
    brotli-dev \
    pcre-dev \
    zlib-dev \
    openssl-dev \
    curl \
    wget \
    busybox-extras
 
# ä¸‹è½½ngx_brotliæ¨¡å—
WORKDIR /usr/src
RUN set -e; \
    echo "ğŸ”§ å°è¯•ä¸‹è½½ngx_brotliæ¨¡å—..."; \
    # é¦–å…ˆå°è¯•GitHubå®˜æ–¹
    if timeout -s TERM 240 \
        git clone --depth=1 --shallow-submodules --recursive https://github.com/google/ngx_brotli.git; then \
        echo "âœ… ä»GitHubä¸‹è½½ngx_brotliæˆåŠŸ"; \
    # å¦‚æœGitHubå¤±è´¥ï¼Œå°è¯•Giteeé•œåƒ
    elif timeout -s TERM 240 \
        git clone --depth=1 https://gitee.com/lirko/ngx_brotli.git; then \
        echo "ğŸ”„ Gitee ä¸»ä»“åº“æˆåŠŸï¼Œå¼€å§‹å¤„ç†å­æ¨¡å—â€¦"; \
        cd ngx_brotli && \
        # æŠŠå­æ¨¡å—åœ°å€æ”¹åˆ° Gitee é•œåƒ
        git submodule set-url deps/brotli https://gitee.com/mities/brotli.git && \
        # æµ…å…‹éš†å­æ¨¡å—
        git submodule update --init --depth=1 --recommend-shallow && \
        echo "âœ… å­æ¨¡å— brotli å·²å°±ä½"; \
        cd ..; \
    else \
        echo "âŒ æ‰€æœ‰ngx_brotliä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"; \
        exit 1; \
    fi

# è·å–Nginxç‰ˆæœ¬
RUN nginx -v 2>&1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' > /tmp/nginx_version

# ç¼–è¯‘Brotliæ¨¡å—
WORKDIR /usr/src/ngx_brotli
RUN set -e; \
    if [ -f "config" ]; then \
        echo "ğŸ”§ å¼€å§‹ç¼–è¯‘Brotliæ¨¡å—..."; \
        NGINX_VERSION=$(cat /tmp/nginx_version); \
        # å°è¯•å¤šä¸ªNginxä¸‹è½½æº
        if wget --timeout=120 --tries=3 https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»nginx.orgä¸‹è½½æˆåŠŸ"; \
        elif wget --timeout=120 --tries=3 https://mirrors.huaweicloud.com/nginx/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»åä¸ºäº‘ä¸‹è½½æˆåŠŸï¼Œæ„Ÿè°¢newbeåšå®¢çš„æ•´ç†"; \
        elif wget --timeout=120 --tries=3 https://mirror.azure.cn/nginx/download/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»Azureä¸‹è½½æˆåŠŸ"; \
        elif wget --timeout=120 --tries=3 https://mirrors.sohu.com/nginx/nginx-${NGINX_VERSION}.tar.gz; then \
            echo "âœ… ä»æœç‹ä¸‹è½½æˆåŠŸ"; \
        else \
            echo "âŒ Nginxæºç ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"; \
            exit 1; \
        fi; \
        tar -xzf nginx-${NGINX_VERSION}.tar.gz && \
        cd nginx-${NGINX_VERSION} && \
        ./configure --with-compat --add-dynamic-module=/usr/src/ngx_brotli && \
        make modules && \
        mkdir -p /usr/local/openresty/nginx/modules/ && \
        cp objs/ngx_http_brotli_filter_module.so /usr/local/openresty/nginx/modules/ 2>/dev/null || true && \
        cp objs/ngx_http_brotli_static_module.so /usr/local/openresty/nginx/modules/ 2>/dev/null || true; \
        echo "ğŸ‰ Brotliæ¨¡å—ç¼–è¯‘å®Œæˆ"; \
    else \
        echo "â­ï¸ ngx_brotliæœªæ­£ç¡®ä¸‹è½½"; \
        exit 1; \
    fi

# åœ¨æ„å»ºé˜¶æ®µå®‰è£…luaæ¨¡å—
WORKDIR /usr/src

# å®‰è£…lua-resty-openssl
RUN set -e; \
    echo "ğŸ”§ å°è¯•å®‰è£…lua-resty-openssl..."; \
    # é¦–å…ˆå°è¯•GitHub
    if timeout -s TERM 240 \
        git clone --depth=1 https://github.com/fffonion/lua-resty-openssl.git; then \
        echo "âœ… ä»GitHubä¸‹è½½lua-resty-opensslæˆåŠŸ"; \
    # å¦‚æœGitHubå¤±è´¥ï¼Œå°è¯•Gitee
    elif timeout -s TERM 240 \
        git clone --depth=1 https://gitee.com/mirrors_fffonion/lua-resty-openssl.git; then \
        echo "ğŸ”„ ä»Giteeä¸‹è½½lua-resty-opensslæˆåŠŸ"; \
    # å¦‚æœéƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½
    elif wget -O lua-resty-openssl.tar.gz https://github.com/fffonion/lua-resty-openssl/archive/refs/heads/master.tar.gz && \
         tar -xzf lua-resty-openssl.tar.gz && mv lua-resty-openssl-master lua-resty-openssl; then \
        echo "ğŸ”„ ä»taråŒ…ä¸‹è½½lua-resty-opensslæˆåŠŸ"; \
    else \
        echo "âŒ lua-resty-opensslä¸‹è½½å¤±è´¥"; \
        exit 1; \
    fi; \
    mkdir -p /usr/local/openresty/lualib/resty/openssl && \
    cd lua-resty-openssl && \
    cp -r lib/resty/openssl/* /usr/local/openresty/lualib/resty/openssl/ 2>/dev/null || true && \
    cp lib/resty/openssl.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true; \
    echo "âœ… lua-resty-opensslå®‰è£…å®Œæˆ"

# å®‰è£…lua-resty-httpæ¨¡å—
RUN set -e; \
    mkdir -p /usr/local/openresty/lualib/resty; \
    echo "ğŸ”§ å°è¯•å®‰è£…lua-resty-http..."; \
    # é¦–å…ˆå°è¯•GitHub
    if timeout -s TERM 240 \
        git clone --depth=1 https://github.com/ledgetech/lua-resty-http.git; then \
        echo "âœ… ä»GitHubä¸‹è½½lua-resty-httpæˆåŠŸ"; \
    # å¦‚æœGitHubå¤±è´¥ï¼Œå°è¯•Gitee
    elif timeout -s TERM 240 \
        git clone --depth=1 https://gitee.com/mirrors_ledgetech/lua-resty-http.git; then \
        echo "ğŸ”„ ä»Giteeä¸‹è½½lua-resty-httpæˆåŠŸ"; \
    # å¦‚æœéƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½
    elif wget -O lua-resty-http.tar.gz https://github.com/ledgetech/lua-resty-http/archive/refs/heads/master.tar.gz && \
         tar -xzf lua-resty-http.tar.gz && mv lua-resty-http-master lua-resty-http; then \
        echo "ğŸ”„ ä»taråŒ…ä¸‹è½½lua-resty-httpæˆåŠŸ"; \
    else \
        echo "âŒ lua-resty-httpä¸‹è½½å¤±è´¥"; \
        exit 1; \
    fi; \
    cd lua-resty-http && \
    cp lib/resty/http.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true && \
    cp lib/resty/http_headers.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true && \
    cp lib/resty/http_connect.lua /usr/local/openresty/lualib/resty/ 2>/dev/null || true && \
    cp -r lib/ngx /usr/local/openresty/lualib/ 2>/dev/null || true; \
    echo "âœ… lua-resty-httpå®‰è£…å®Œæˆ"

# æœ€ç»ˆé•œåƒ
FROM openresty/openresty:1.25.3.1-alpine

RUN apk update

# åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    brotli \
    pcre \
    zlib \
    openssl

# åˆ›å»ºnginxç”¨æˆ·å’Œç»„
RUN addgroup -g 101 -S nginx && \
    adduser -S -D -H -u 101 -h /var/cache/nginx -s /sbin/nologin -G nginx -g nginx nginx

# åˆ›å»ºå¿…è¦çš„ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /var/log/nginx /var/cache/nginx /var/run /tmp && \
    chown -R nginx:nginx /var/log/nginx /var/cache/nginx /var/run && \
    chmod -R 755 /var/log/nginx /var/cache/nginx /var/run && \
    chmod 777 /tmp

# ä»builderä¸­å¤åˆ¶Brotliæ¨¡å—å’Œluaæ¨¡å—
COPY --from=builder /usr/local/openresty/nginx/modules/ /usr/local/openresty/nginx/modules/
COPY --from=builder /usr/local/openresty/lualib/ /usr/local/openresty/lualib/

# åˆ›å»ºé…ç½®ç›®å½•
RUN mkdir -p /usr/local/openresty/nginx/conf/conf.d

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®
COPY nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

# å¤åˆ¶é…ç½®æ¨¡æ¿æ–‡ä»¶
COPY default.http.conf /usr/local/openresty/nginx/conf/conf.d/default.http.conf.template
COPY default.https.conf /usr/local/openresty/nginx/conf/conf.d/default.https.conf.template

# åœ¨æ„å»ºæ—¶å°±å¤„ç†é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨HTTPé…ç½®
RUN cp /usr/local/openresty/nginx/conf/conf.d/default.http.conf.template \
       /usr/local/openresty/nginx/conf/conf.d/default.conf

# è®¾ç½®nginxç›¸å…³ç›®å½•çš„æƒé™
RUN chown -R nginx:nginx /usr/local/openresty/nginx/ && \
    chmod -R 755 /usr/local/openresty/nginx/conf/ && \
    # ç»™nginxç”¨æˆ·é…ç½®ç›®å½•çš„å†™æƒé™
    chmod 775 /usr/local/openresty/nginx/conf/conf.d/ && \
    # åˆ›å»ºå¹¶è®¾ç½®nginxç›®å½•æƒé™
    mkdir -p /usr/share/nginx/html && \
    chown -R nginx:nginx /usr/share/nginx && \
    chmod -R 755 /usr/share/nginx && \
    # åˆ›å»ºå¹¶è®¾ç½®Let's EncryptéªŒè¯ç›®å½•æƒé™
    mkdir -p /usr/share/nginx/html/.well-known/acme-challenge && \
    chown -R nginx:nginx /usr/share/nginx/html/.well-known && \
    chmod -R 777 /usr/share/nginx/html/.well-known && \
    # åˆ›å»ºå¹¶è®¾ç½®SSLè¯ä¹¦ç›®å½•æƒé™ï¼ˆnginxéœ€è¦è¯»å–è¯ä¹¦æ–‡ä»¶ï¼‰
    mkdir -p /etc/letsencrypt /var/lib/letsencrypt && \
    chown -R nginx:nginx /etc/letsencrypt /var/lib/letsencrypt && \
    chmod -R 755 /etc/letsencrypt /var/lib/letsencrypt && \
    # åˆ›å»ºå¹¶è®¾ç½®æ•°æ®ç›®å½•æƒé™ï¼ˆnginxéœ€è¦è¯»å–sitemap.xmlå’Œrobots.txtï¼‰
    mkdir -p /app/data && \
    chown nginx:nginx /app/data && \
    chmod 755 /app/data && \
    # åˆ›å»ºå¹¶è®¾ç½®luaè„šæœ¬ç›®å½•æƒé™ï¼ˆnginxéœ€è¦è¯»å–luaè„šæœ¬æ–‡ä»¶ï¼‰
    mkdir -p /etc/nginx/lua && \
    chown nginx:nginx /etc/nginx/lua && \
    chmod 755 /etc/nginx/lua

# æš´éœ²ç«¯å£
EXPOSE 80 443/tcp 443/udp

# åˆ‡æ¢åˆ°nginxç”¨æˆ·
USER nginx

# å¯åŠ¨å‘½ä»¤
CMD ["openresty", "-g", "daemon off;"]