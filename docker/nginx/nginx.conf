user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log error;
pid /tmp/nginx.pid;

# Brotli模块需要动态加载
load_module /usr/local/openresty/nginx/modules/ngx_http_brotli_filter_module.so;
load_module /usr/local/openresty/nginx/modules/ngx_http_brotli_static_module.so;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /usr/local/openresty/nginx/conf/mime.types;
    default_type application/octet-stream;
    
    # Docker DNS解析器 - 添加此行解决容器名解析问题
    resolver 127.0.0.11 valid=30s;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
    
    # 只记录非静态资源的访问日志，减少日志量
    map $request_uri $loggable {
        ~*\.(ico|css|js|gif|jpe?g|png|svg|woff2?|ttf|eot|map)$ 0;
        ~*/api/ 0;
        ~*/python/ 0;
        ~*/socket 0;
        default 1;
    }
    
    access_log /var/log/nginx/access.log main if=$loggable;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # 定义Lua模块搜索路径 (OpenResty已包含所有必要的路径)
    lua_package_path "/etc/nginx/lua/?.lua;/usr/local/openresty/lualib/?.lua;/usr/local/openresty/site/lualib/?.lua;/usr/local/openresty/luajit/share/lua/5.1/?.lua;/usr/local/openresty/luajit/share/lua/5.1/?/init.lua;;";
    lua_package_cpath "/usr/local/openresty/lualib/?.so;/usr/local/openresty/site/lualib/?.so;/usr/local/openresty/luajit/lib/lua/5.1/?.so;;";
    
    # OpenResty已内置resty.core支持
    # lua_load_resty_core on; 

    # SEO数据缓存
    lua_shared_dict seo_cache 10m;

    # 添加正确的MIME类型处理
    types {
        application/javascript js;
        text/javascript js;
    }

    include /usr/local/openresty/nginx/conf/conf.d/*.conf;
} 