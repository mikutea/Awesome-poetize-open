# 系统架构设计

## 架构概览

POETIZE 博客系统采用前后端分离的微服务架构，基于容器化部署，支持高并发和可扩展性。

## 技术栈

| 组件                | 技术               | 版本             |
| ------------------- | ------------------ | ---------------- |
| **前端**      | Vue.js             | 2.x / 3.x        |
| **后端**      | Spring Boot + Java | 3.5.5 / 25       |
| **辅助后端**  | FastAPI + Python   | 3.9+             |
| **数据库**    | MariaDB + Redis    | 11.1+ / 7-alpine |
| **Web服务器** | Nginx (OpenResty)  | 1.25.3.1         |
| **部署**      | Docker & Compose   | Latest           |

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户访问层                              │
│  https://domain.com/ (主站)                                     │
│  https://domain.com/admin (管理后台)                             │
│  https://domain.com/im (聊天室)                                 │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│              Nginx (唯一对外暴露端口 80/443)                      │
│  - 反向代理 (转发到 Java/Python 后端)                            │
│  - 静态资源服务 (从 Volume 读取前端构建产物)                      │
│  - SSL 终端 (Let's Encrypt)                                     │
│  - WebSocket 代理 (聊天室)                                       │
└──────────────┬──────────────────────────────────────────────────┘
               │
   ┌───────────┼───────────┐
   │           │           │
   ▼           ▼           ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│  Java   │ │ Python  │ │ 预渲染   │
│ 后端    │ │ 后端    │ │ 服务     │
│ 8081    │ │ 5000    │ │ 4000    │
│ 内部网  │ │ 内部网  │ │ 内部网   │
└─────────┘ └─────────┘ └─────────┘
     ▲           ▲
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│ MariaDB │ │  Redis  │
│ 3306    │ │ 6379    │
│ 内部网  │ │ 内部网  │
└─────────┘ └─────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      构建层 (一次性任务)                          │
│  ┌──────────────┐  ┌──────────────┐                              │
│  │ poetize-ui   │  │ poetize-im-ui│                              │
│  │ Vue2 构建服务 │  │ Vue3 构建服务 │                              │
│  │ ↓ 输出静态文件 │  │ ↓ 输出静态文件 │                              │
│  └─ Volume ─────┘  └─ Volume ─────┘                              │
│       ↓                 ↓                                       │
│  ┌────┴─────────────────┴────┐                                   │
│  │    poetize_ui_dist        │                                   │
│  │    poetize_im_dist        │                                   │
│  └────┬──────────────┬───────┘                                   │
│       ↓              ↓                                         │
│  ┌────┴────┐  ┌──────┴──────┐                                   │
│  │  Nginx  │  │   Nginx     │                                   │
│  │ 静态目录 │  │  静态目录    │                                   │
│  └─────────┘  └─────────────┘                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 前端层 (构建服务)

**poetize-ui (Vue 2 构建服务)**

- 博客主站和管理后台的源代码
- 构建后输出到 Volume: `poetize_ui_dist`
- 被 Nginx 挂载为静态资源目录
- 特性: 响应式设计、暗色模式、Live2D 看板娘
- 构建完成后容器退出 (restart: "no")

**poetize-im-ui (Vue 3 构建服务)**

- 聊天室前端源代码
- 构建后输出到 Volume: `poetize_im_dist`
- 被 Nginx 挂载为 `/im` 静态资源
- 特性: WebSocket 实时通信、消息历史
- 构建完成后容器退出 (restart: "no")

### 2. 服务层

**Java 后端 (Spring Boot 3.5.5)**

- 端口: 8081
- 职责:

  - 用户认证授权 (JWT + HMAC-SHA256)
  - 文章管理 (CRUD)
  - 评论系统 (多级评论)
  - 社交功能 (点赞/收藏)
  - 文件上传
  - SEO 优化 (sitemap/robots.txt)
  - 邮件服务
  - AI 聊天配置

**Python 后端 (FastAPI)**

- 端口: 5000
- 职责:
  - OAuth 第三方登录 (GitHub/Google/Twitter/Yandex/Gitee)
  - 机器翻译 (中英互译)
  - 摘要生成

### 3. 数据层

**MariaDB 11**

- 端口: 3306
- 多存储引擎优化:
  - InnoDB: 事务型表 (用户/文章/评论)
  - Aria: 读密集型表 (分类/标签/配置)
  - RocksDB: 写入优化表 (聊天记录)

**Redis 7**

- 端口: 6379
- 用途:
  - Session 缓存
  - API 响应缓存
  - 限流计数
  - WebSocket 在线状态

### 4. 基础设施

**Nginx (OpenResty 1.25.3.1)**

- 端口: 80/443
- 功能:
  - 反向代理
  - SSL 终端
  - 静态资源服务
  - 负载均衡

**预渲染服务 (Node.js)**

- 端口: 4000
- 用途: SEO 预渲染，提升搜索引擎收录

## 部署架构

### 容器编排 (Docker Compose)

```yaml
服务列表:
  nginx:           # 反向代理
  poetize-ui:      # 前端构建
  poetize-im-ui:   # 聊天室构建
  java-backend:    # Java 后端
  python-backend:  # Python 后端
  mysql:           # MariaDB
  redis:           # 缓存
  prerender:       # 预渲染
  certbot:         # SSL 证书
```

### 网络配置

```yaml
网络: poetize-network
子网: 172.28.147.0/28 (16 个 IP)
网关: 172.28.147.1
```

### 数据卷

```yaml
- mysql_data:        # 数据库数据
- redis_data:        # Redis 数据
- certbot-etc:       # SSL 证书
- certbot-var:       # 证书工作目录
- web-root:          # Web 根目录
- poetize_ui_dist:   # 前端主站构建产物
- poetize_im_dist:   # 聊天室构建产物
- poetize_uploads:   # 用户上传文件
```

## 安全设计

### 认证授权

1. **Token 机制**

   - HMAC-SHA256 签名
   - 防伪造、防篡改、防重放攻击
2. **密码安全**

   - BCrypt 哈希 (替代 MD5)
   - 随机盐值
3. **OAuth 代理**

   - 支持海外平台代理
   - 解决国内访问问题

### 访问控制

- RBAC 角色权限模型
- 接口级权限验证
- 频率限制 (滑块验证码)

## 性能优化

### 缓存策略

- **前端**: 路由懒加载、资源压缩
- **后端**: Redis 多级缓存
- **数据库**: 索引优化、慢查询分析
- **静态资源**: CDN 加速

### 预渲染

- 自动生成静态 HTML
- 提升 SEO 效果
- 搜索引擎友好

## 快速开始

```bash
# 一键部署
curl -sL install.leapya.com | bash

# 或克隆部署
git clone https://github.com/LeapYa/Awesome-poetize-open.git
cd Awesome-poetize-open
sudo chmod +x deploy.sh
sudo ./deploy.sh
```

## 开发环境

```bash
# 启动依赖服务
docker compose up -d mysql redis

# 启动后端
cd poetize-server && mvn spring-boot:run
cd py && uvicorn main:app --port 5000 --reload

# 启动前端
cd poetize-ui && npm install && npm run serve
cd poetize-im-ui && npm install && npm run serve
```

## 项目结构

```
.
├── docker/                 # Docker 配置
├── docker-compose.yml      # 服务编排
├── poetize-server/         # Java 后端
│   └── poetry-web/
├── poetize-ui/             # Vue2 前端
├── poetize-im-ui/          # Vue3 聊天室
├── py/                     # Python 后端
├── deploy.sh               # 部署脚本
├── migrate.sh              # 迁移脚本
└── docs/                   # 文档
```

## 监控与日志

```bash
# 查看服务状态
docker ps

# 查看日志
docker compose logs -f

# 健康检查
docker exec poetize-java curl -f http://localhost:8081/actuator/health
```

## 常见问题

### 部署失败

```bash
# 清理并重新部署
docker system prune -af
rm -rf Awesome-poetize-open
bash <(curl -sL install.leapya.com)
```

### 内存不足

```bash
# 创建 swap 分区
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### HTTPS 证书问题

```bash
# 重新申请
docker exec poetize-nginx /enable-https.sh
```

## 许可协议

AGPL-3.0 License

## 贡献指南

欢迎提交 Issue 和 Pull Request！

## 联系方式

- 邮箱: enable_lazy@qq.com
- GitHub: [Issues](https://github.com/LeapYa/Awesome-poetize-open/issues)
